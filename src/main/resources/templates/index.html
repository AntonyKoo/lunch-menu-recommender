<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="UTF-8">
    <title>한솥도시락 메뉴 추천</title>
    <!-- 부트스트랩 CSS 링크 추가 -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- 추가 CSS 파일 링크 -->
    <!--    <link rel="stylesheet" href="styles/main.css">-->
    <style>
        /* 컨베이어 벨트 애니메이션 */
        .menu-conveyor {
            white-space: nowrap;
            overflow: hidden;
            position: relative;
        }

        .menu-item {
            display: inline-block;
            padding: 10px;
            margin-right: 20px;
        }

        /* 컨베이어 벨트 애니메이션 */
        @keyframes conveyor {
            0% {
                transform: translateX(100%);
            }
            100% {
                transform: translateX(-100%);
            }
        }

        .menu-conveyor .menu-item {
            animation: conveyor 10s linear infinite;
        }

        /* 수정된 CSS */
        .btn-group {
            /* 버튼 그룹을 수평으로 정렬 */
            display: flex;
            justify-content: space-between; /* 가로 방향에 여백을 고르게 배분 */
            align-items: center; /* 세로 방향 중앙 정렬 */
            width: 33.33%; /* 전체 너비의 1/3만큼 차지하도록 설정 */
            margin: 0 auto; /* 가운데 정렬 */
        }

        .btn {
            /* 버튼 스타일 초기화 */
            font-size: 1rem; /* 기본 폰트 크기로 설정 */
            width: auto; /* 버튼이 부모 요소의 너비를 가득 채우도록 설정 */
            border-radius: 5px; /* 버튼의 모서리를 둥글게 만듦 */
        }

        /* 더 큰 화면에서는 버튼 크기를 더 크게 만듭니다 */
        @media (min-width: 768px) {
            .btn {
                /* min-width 속성 삭제하여 버튼 크기를 자동으로 조절 */
                margin: 0 10px; /* 좌우 간격을 10px로 설정 */
            }
        }
    </style>
</head>
<body>

<!-- 로그인 모달 -->
<div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="loginModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="loginModalLabel">로그인</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- 로그인 폼 -->
                <form id="loginForm" th:action="@{/login}" method="post">
                    <!-- 잘못된 로그인 정보가 입력되었을 때 -->
                    <div th:if="${param.error}">
                        <div class="alert alert-danger">
                            사용자ID 또는 비밀번호를 확인해 주세요.
                        </div>
                    </div>
                    <div class="form-group">
                        <label th:for="email">이메일</label>
                        <input type="text" class="form-control" placeholder="이메일을 입력해 주세요." id="loginEmail" name="email"
                               required>
                    </div>
                    <div class="form-group">
                        <label th:for="loginPassword">비밀번호</label>
                        <input type="password" class="form-control" placeholder="비밀번호를 입력해 주세요." id="loginPassword"
                               name="password" required>
                    </div>
                    <button type="submit" class="btn btn-primary">로그인</button>
                </form>
                <div id="loggedInUser" style="display: none;">
                    <span id="signinUsername"></span>님 환영합니다.
                    <button id="logoutBtn" sec:authorize="isAuthenticated()">로그아웃</button>
                </div>
                <!-- 회원가입 폼 -->
                <form id="signupForm" style="display: none;" th:action="@{/members/new}" method="post"
                      th:object="${memberFormDto}">
                    <!--                    <div th:replace="~{form_errors :: formErrorsFragment}"></div>-->
                    <div class="form-group">
                        <label th:for="username" class="form-label">사용자 ID</label>
                        <input type="text" class="form-control" placeholder="이름을 입력해 주세요." required>
                    </div>
                    <div class="form-group">
                        <label th:for="email" class="form-label">이메일</label>
                        <input type="email" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label th:for="password" class="form-label">비밀번호</label>
                        <input type="password" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-primary">가입하기</button>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="showLogin">로그인</button>
                <button type="button" class="btn btn-primary" id="showSignup">회원가입</button>
            </div>
        </div>
    </div>
</div>


<!-- 메인 컨테이너 -->
<div class="container mt-5">
    <!-- 페이지 제목 -->
    <h1 class="text-center mb-4">한솥도시락 메뉴 추천</h1>

    <!-- 버튼 그룹 -->
    <div class="text-center mb-4">
        <div class="btn-group" role="group">
            <!--            <button type="button" class="btn btn-primary mr-2" data-toggle="modal" data-target="#loginModal">로그인</button>-->
            <button type="button" class="btn btn-info rounded-pill btn-block" data-toggle="modal" data-target="#loginModal">로그인</button>
            <form th:action="@{/api/v1/recommend/menu}" method="get" style="display: inline;">
                <button type="submit" class="btn btn-success mr-2 rounded-pill btn-block" id="menuRecommendRequestBtn">메뉴 추천받기</button>
            </form>
            <button type="button" class="btn btn-info rounded-pill btn-block" data-toggle="modal" data-target="#menuModal">메뉴 등록하기</button>
        </div>
    </div>


    <!-- 추천 메뉴 카드 -->
    <div class="text-center">
        <div class="card mt-3" th:if="${recommendedMenu}">
            <!--    <div class="card mt-3" th:if="${recommendedMenu}">-->
            <!-- th:if= 는 해당 변수가 존재하고 빈 값이 아닐때만 해당 영역을 표시해준다고 함. 그래서 unless로 변경-->
            <div class="card-header">
                <h5>추천 메뉴</h5>
            </div>
            <div class="card-body d-flex align-items-center justify-content-center">
                <div class="card" style="width: 270px; height: 335px;">
                    <img class="card-img-top2" th:src="@{/images/{imageName}(imageName=${recommendedMenu.imagePath})}"
                         style="width: 100%; height: 230px; object-fit: cover;" alt="Menu Image">
                    <div class="card-body" style="max-height: calc(100% - 105px); overflow: auto;">
                        <h5 class="card-title2" th:text="${recommendedMenu.name}"></h5>
                        <p class="card-text.price">가격: <span th:text="${recommendedMenu.price}"></span>원</p>
                        <p class="card-text.review">리뷰: <span th:text="${recommendedMenu.review}"></span></p>
                        <!--                        <p class="card-text.review" th:text="${recommendedMenu.review}"></p>-->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="card mt-3" th:unless="${recommendedMenu}">
        <!--    <div class="card mt-3" th:if="${recommendedMenu}">-->
        <!-- th:if= 는 해당 변수가 존재하고 빈 값이 아닐때만 해당 영역을 표시해준다고 함. 그래서 unless로 변경-->
        <div class="card-header">
            <h5>추천 메뉴</h5>
        </div>
        <div class="card-body">
            <p class="card-title">추천 메뉴가 없습니다.🥲</p>
        </div>
    </div>

    <!-- 등록된 모든 메뉴 -->
    <div class="mt-4">
        <div class="card-header">
            <h5>등록된 메뉴</h5>
        </div>
        <div class="menu-conveyor row" th:if="${menuList}">
            <!-- 메뉴 아이템(카드)들 -->
            <div th:each="menu, menuStat : ${menuList}" class="col-md-3 mb-2 menu-item"
                 style="animation-delay: [[${menuStat.index * 0.5}]]s;">
                <div class="card" style="width: 270px; height: 335px;">
                    <img class="card-img-top" th:src="|data:image/jpeg;base64,${menu.imagePath}|" alt="Menu Image"
                         style="width: 100%; height:
                230px; object-fit: cover;">
                    <!--                <img class="card-img-top" th:src="@{/images/} + ${menu.imagePath}" alt="Menu Image">-->
                    <!--                <img class="card-img-top" th:if="${menu.imagePath == null or !T(java.nio.file.Files).exists(T(org.springframework.util.ResourceUtils).getFile('classpath:/images/' + ${menu.imagePath}))}" th:src="@{/images/default.jpeg}" alt="Default Image">-->
                    <div class="card-body" style="max-height: calc(100% - 105px); overflow: auto;">
                        <!-- menu name -->
                        <h5 class="card-title" th:text="${menu.name}"></h5>
                        <!-- price -->
                        <p class="card-text">가격: <span th:text="${menu.price}">원</span></p>
                        <!-- review -->
                        <!--                        <p class="card-text" th:text="${menu.review}"></p>-->
                        <p class="card-text">리뷰: <span th:text="${menu.review}"></span></p>
                    </div>
                </div>
                <!-- 등록된 메뉴가 없을 때 -->
                <div th:unless="${menuList}">
                    <p>등록된 메뉴가 없습니다.🥲</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 메뉴 등록 모달 -->
<div class="modal fade" id="menuModal" tabindex="-1" role="dialog" aria-labelledby="menuModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="menuModalLabel">메뉴 등록하기</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- 단일 메뉴 등록 폼 -->
                <div id="singleMenuForm">
                    <h2>단일 메뉴 등록하기</h2>
                    <form id="menuForm">
                        <!-- 메뉴 정보 입력 필드 -->
                        <div class="form-group">
                            <label for="menuName">메뉴 이름:</label>
                            <input type="text" class="form-control" id="menuName" name="menuName" required>
                        </div>
                        <!-- 가격 입력 필드 -->
                        <div class="form-group">
                            <label for="menuPrice">가격:</label>
                            <input type="number" class="form-control" id="menuPrice" name="menuPrice" required>
                        </div>
                        <!-- 리뷰 입력 필드 -->
                        <div class="form-group">
                            <label for="menuReview">리뷰:</label>
                            <textarea class="form-control" id="menuReview" name="menuReview" rows="3"
                                      maxlength="255"></textarea>
                        </div>
                        <!-- 이미지 등록 버튼 -->
                        <div class="row mb-3">
                            <div class="col">
                                <div class="form-group">
                                    <label for="image">이미지 등록하기:</label>
                                    <label for="image" class="btn btn-primary btn-file">
                                        이미지 선택하기 <input type="file" class="form-control-file" id="image"
                                                        name="menuImage" accept="image/*" required
                                                        style="display: none;">
                                    </label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <!-- 저장하기, 여러 메뉴 등록하기, 닫기 버튼 -->
                <div class="d-flex justify-content-between">
                    <button type="button" class="btn btn-primary" data-dismiss="modal">여러 메뉴 등록하기</button>
                    <div>
                        <button type="button" class="btn btn-primary mr-2" id="saveMenuBtn">저장하기</button>
                        <button type="button" class="btn btn-secondary" id="closeModalBtn">닫기</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- 부트스트랩 및 jQuery 스크립트 추가 -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<!--    // "단일 메뉴 등록하기" 버튼 클릭 시 모달 열기-->
<!--        // 단일 메뉴 등록 폼을 보여줌-->
<script>
    document.getElementById('showSingleMenuForm').addEventListener('click', function() {
        $('#singleMenuForm').show();
    });
</script>

<script>
    // "닫기" 버튼 클릭 시 모달 닫기
    document.getElementById('closeModalBtn').addEventListener('click', function() {
        $('#menuModal').modal('hide');
    });
</script>

<!-- 메뉴 등록하기 버튼을 누르면 클릭하면 POST 요청을 보내는 코드-->
<!-- JS로 버튼 클릭 이벤트 처리, fetch API로 POST 요청 보내기-->
<!-- JavaScript 코드 추가 -->
<script>
    // 저장하기 버튼 클릭 시 POST 요청 보내기
    document.getElementById('saveMenuBtn').addEventListener('click', function() {
        // 이미지 파일 가져오기
        var imageFile = document.getElementById('image').files[0];

        // 이미지 파일이 선택되었는지 확인
        if (imageFile) {
            // 메뉴 정보를 FormData 객체에 추가
            var formData = new FormData();
            formData.append('imageFile', imageFile);
            formData.append('name', document.getElementById('menuName').value);
            formData.append('price', document.getElementById('menuPrice').value);
            formData.append('review', document.getElementById('menuReview').value);

            // POST 요청 보내기, FormData로 이미지 파일을 전송할 때 일반적으로 헤더를 추가하지 X
            fetch('/api/v1/register/menu', {
                method: 'POST',
                body: formData,
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.text();
            })
            .then(data => {
                // 성공적으로 응답을 받았을 때의 처리 작성
                console.log('Menu registered:', data);
                // 모달 닫기
                $('#menuModal').modal('hide');
            })
            .catch(error => {
                // 오류 발생 시의 처리 작성
                console.error('Error registering menu:', error);
                // 오류 메시지 표시 등의 추가 작업 가능
            });
        } else {
            // 이미지 파일이 선택되지 않은 경우, 예외처리
            console.error('No image file selected');
        }
    });
</script>
<script>
    document.getElementById("showSignup").addEventListener("click", function () {
        document.getElementById("loginModalLabel").innerText = "회원가입";
        document.getElementById("loginForm").style.display = "none";
        document.getElementById("signupForm").style.display = "block";
    });

    document.getElementById("showLogin").addEventListener("click", function () {
        document.getElementById("loginModalLabel").innerText = "로그인";
        document.getElementById("loginForm").style.display = "block";
        document.getElementById("signupForm").style.display = "none";
    });
</script>
<script>
    // "로그인" 버튼 클릭 시 모달 열기
    document.getElementById("showLogin").addEventListener("click", function () {
        $('#loginModal').modal('show'); // 모달을 보이도록 설정
    });
</script>
<script>
    // 모달 로그인 폼에서 제출 이벤트 처리
    document.getElementById("loginForm").addEventListener("submit", function(event) {
      event.preventDefault(); // 폼의 기본 동작을 막습니다.
      let formData = new FormData(this); // 폼 데이터를 가져옵니다.

      // 서버에 인증 요청을 보냅니다.
      fetch('/login', {
        method: 'POST',
        body: formData
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Login failed');
        }
        return response.json();
      })
      .then(data => {
      // 성공적으로 인증되었을 때 처리 로직을 작성합니다.
        console.log('Login successful', data);
        document.getElementById("loginForm").reset(); // 폼 초기화
        document.getElementById("loginModal").style.display = "none"; // 모달 숨기기
        document.getElementById("loggedInUser").style.display = "block"; // 로그인 성공 메시지 표시
        document.getElementById("signinUsername").textContent = data.username; // 사용자 이름 표시

        // 로그아웃 버튼 이벤트 처리
        document.getElementById("logoutBtn").addEventListener("click", function() {
        // 여기에 로그아웃 처리 로직을 작성합니다.
        console.log('Logout clicked');
        });
      })
      .catch(error => {
        // 인증 실패 시 처리 로직을 작성합니다.
        console.error('Login failed', error);
        alert('Login failed. Please check your username and password.');
        document.getElementById("loginForm").reset(); // 폼 초기화
      });
    });
</script>
</body>
</html>